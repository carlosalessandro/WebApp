@model dynamic
@{
    ViewData["Title"] = "Executar Relatório";
    var relatorio = ViewBag.Relatorio as WebApp.Models.RelatorioPCP;
    var campos = ViewBag.Campos as List<string> ?? new List<string>();
}

<div class="container-fluid mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2><i class="bi bi-file-bar-graph"></i> @relatorio?.Nome</h2>
            <p class="text-muted mb-0">@relatorio?.Descricao</p>
        </div>
        <div class="d-flex gap-2">
            <button type="button" class="btn btn-outline-primary" onclick="exportarExcel()">
                <i class="bi bi-file-earmark-excel"></i> Exportar Excel
            </button>
            <button type="button" class="btn btn-outline-secondary" onclick="exportarPDF()">
                <i class="bi bi-file-earmark-pdf"></i> Exportar PDF
            </button>
            <a asp-action="Index" class="btn btn-secondary">
                <i class="bi bi-arrow-left"></i> Voltar
            </a>
        </div>
    </div>

    @if (relatorio != null)
    {
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-info-circle"></i> Informações do Relatório
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <strong>Tipo:</strong> @relatorio.TipoRelatorio
                    </div>
                    <div class="col-md-3">
                        <strong>Criado por:</strong> @relatorio.CriadoPor?.Name
                    </div>
                    <div class="col-md-3">
                        <strong>Data de Criação:</strong> @relatorio.DataCriacao.ToString("dd/MM/yyyy HH:mm")
                    </div>
                    <div class="col-md-3">
                        <strong>Público:</strong> 
                        @if (relatorio.Publico)
                        {
                            <span class="badge bg-success">Sim</span>
                        }
                        else
                        {
                            <span class="badge bg-secondary">Não</span>
                        }
                    </div>
                </div>
            </div>
        </div>
    }

    <div class="card">
        <div class="card-header">
            <h5 class="mb-0">
                <i class="bi bi-table"></i> Dados do Relatório
            </h5>
        </div>
        <div class="card-body">
            @if (Model != null)
            {
                var dados = Model as IEnumerable<object>;
                if (dados != null && dados.Any())
                {
                    <div class="table-responsive">
                        <table class="table table-striped table-hover" id="tabelaRelatorio">
                            <thead class="table-dark">
                                <tr>
                                    @if (relatorio?.TipoRelatorio == "Ordens de Produção" || relatorio?.TipoRelatorio == "Personalizado")
                                    {
                                        <th>Número da Ordem</th>
                                        <th>Produto</th>
                                        <th>Quantidade</th>
                                        <th>Quantidade Produzida</th>
                                        <th>Status</th>
                                        <th>Prioridade</th>
                                        <th>Data Início Prevista</th>
                                        <th>Data Fim Prevista</th>
                                        <th>Data Início Real</th>
                                        <th>Data Fim Real</th>
                                    }
                                    else if (relatorio?.TipoRelatorio == "Apontamentos")
                                    {
                                        <th>Número da Ordem</th>
                                        <th>Produto</th>
                                        <th>Qtd. Produzida</th>
                                        <th>Qtd. Refugo</th>
                                        <th>Qtd. Retrabalho</th>
                                        <th>Data/Hora</th>
                                        <th>Operador</th>
                                        <th>Tempo Produção (min)</th>
                                        <th>Tempo Setup (min)</th>
                                        <th>Tempo Parado (min)</th>
                                        <th>Motivo Parada</th>
                                    }
                                    else if (relatorio?.TipoRelatorio == "Recursos")
                                    {
                                        <th>Código</th>
                                        <th>Nome</th>
                                        <th>Tipo</th>
                                        <th>Capacidade/Hora</th>
                                        <th>Custo/Hora</th>
                                        <th>Disponível</th>
                                        <th>Em Manutenção</th>
                                        <th>Localização</th>
                                    }
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var item in dados)
                                {
                                    <tr>
                                        @if (relatorio?.TipoRelatorio == "Ordens de Produção" || relatorio?.TipoRelatorio == "Personalizado")
                                        {
                                            var ordem = item as WebApp.Models.OrdemProducao;
                                            if (ordem != null)
                                            {
                                                <td>@ordem.NumeroOrdem</td>
                                                <td>@ordem.Produto?.Nome</td>
                                                <td>@ordem.Quantidade</td>
                                                <td>@ordem.QuantidadeProduzida</td>
                                                <td>
                                                    <span class="badge bg-@(ordem.Status == "Concluída" ? "success" : ordem.Status == "Em Andamento" ? "warning" : "secondary")">
                                                        @ordem.Status
                                                    </span>
                                                </td>
                                                <td>@ordem.Prioridade</td>
                                                <td>@ordem.DataInicioPrevista?.ToString("dd/MM/yyyy")</td>
                                                <td>@ordem.DataFimPrevista?.ToString("dd/MM/yyyy")</td>
                                                <td>@ordem.DataInicioReal?.ToString("dd/MM/yyyy HH:mm")</td>
                                                <td>@ordem.DataFimReal?.ToString("dd/MM/yyyy HH:mm")</td>
                                            }
                                        }
                                        else if (relatorio?.TipoRelatorio == "Apontamentos")
                                        {
                                            var apontamento = item as WebApp.Models.ApontamentoProducao;
                                            if (apontamento != null)
                                            {
                                                <td>@apontamento.OrdemProducao?.NumeroOrdem</td>
                                                <td>@apontamento.OrdemProducao?.Produto?.Nome</td>
                                                <td>@apontamento.QuantidadeProduzida</td>
                                                <td>@apontamento.QuantidadeRefugo</td>
                                                <td>@apontamento.QuantidadeRetrabalho</td>
                                                <td>@apontamento.DataHoraApontamento.ToString("dd/MM/yyyy HH:mm")</td>
                                                <td>@apontamento.Operador?.Name</td>
                                                <td>@apontamento.TempoProducaoMinutos</td>
                                                <td>@apontamento.TempoSetupMinutos</td>
                                                <td>@apontamento.TempoParadoMinutos</td>
                                                <td>@apontamento.MotivoParada</td>
                                            }
                                        }
                                        else if (relatorio?.TipoRelatorio == "Recursos")
                                        {
                                            var recurso = item as WebApp.Models.Recurso;
                                            if (recurso != null)
                                            {
                                                <td>@recurso.Codigo</td>
                                                <td>@recurso.Nome</td>
                                                <td>@recurso.Tipo</td>
                                                <td>@recurso.CapacidadePorHora</td>
                                                <td>@recurso.CustoPorHora.ToString("C")</td>
                                                <td>
                                                    <span class="badge bg-@(recurso.Disponivel ? "success" : "danger")">
                                                        @(recurso.Disponivel ? "Sim" : "Não")
                                                    </span>
                                                </td>
                                                <td>
                                                    <span class="badge bg-@(recurso.EmManutencao ? "warning" : "success")">
                                                        @(recurso.EmManutencao ? "Sim" : "Não")
                                                    </span>
                                                </td>
                                                <td>@recurso.Localizacao</td>
                                            }
                                        }
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                }
                else
                {
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i> Nenhum dado encontrado para este relatório.
                    </div>
                }
            }
            else
            {
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle"></i> Erro ao carregar os dados do relatório.
                </div>
            }
        </div>
    </div>
</div>

@section Scripts {
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>

<script>
    function exportarExcel() {
        const tabela = document.getElementById('tabelaRelatorio');
        if (!tabela) {
            alert('Nenhuma tabela encontrada para exportar');
            return;
        }

        const wb = XLSX.utils.table_to_book(tabela, { sheet: "Relatório" });
        const nomeArquivo = `relatorio_@(relatorio?.Nome?.Replace(" ", "_"))_${new Date().toISOString().split('T')[0]}.xlsx`;
        XLSX.writeFile(wb, nomeArquivo);
    }

    function exportarPDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('l', 'mm', 'a4'); // landscape orientation

        // Título
        doc.setFontSize(16);
        doc.text('@relatorio?.Nome', 14, 20);
        
        // Subtítulo
        doc.setFontSize(10);
        doc.text(`Gerado em: ${new Date().toLocaleDateString('pt-BR')}`, 14, 30);

        // Tabela
        const tabela = document.getElementById('tabelaRelatorio');
        if (tabela) {
            doc.autoTable({
                html: tabela,
                startY: 40,
                styles: { fontSize: 8 },
                headStyles: { fillColor: [52, 58, 64] },
                margin: { top: 40 }
            });
        }

        const nomeArquivo = `relatorio_@(relatorio?.Nome?.Replace(" ", "_"))_${new Date().toISOString().split('T')[0]}.pdf`;
        doc.save(nomeArquivo);
    }

    // Inicializar DataTable se disponível
    $(document).ready(function() {
        if ($.fn.DataTable && $('#tabelaRelatorio').length) {
            $('#tabelaRelatorio').DataTable({
                language: {
                    url: '//cdn.datatables.net/plug-ins/1.13.7/i18n/pt-BR.json'
                },
                responsive: true,
                pageLength: 25,
                order: [[0, 'desc']]
            });
        }
    });
</script>
}
