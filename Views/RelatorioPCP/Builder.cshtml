@{
    ViewData["Title"] = "Construtor de Relatórios PCP";
}

<div class="container-fluid mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="bi bi-tools"></i> Construtor de Relatórios PCP</h2>
        <button type="button" class="btn btn-success" onclick="salvarRelatorio()">
            <i class="bi bi-save"></i> Salvar Relatório
        </button>
    </div>

    <div class="row">
        <!-- Painel Esquerdo - Campos Disponíveis -->
        <div class="col-md-3">
            <div class="card mb-3">
                <div class="card-header bg-primary text-white">
                    <h6 class="mb-0"><i class="bi bi-database"></i> Fonte de Dados</h6>
                </div>
                <div class="card-body">
                    <select class="form-select" id="fonteDados" onchange="carregarCampos()">
                        <option value="">Selecione...</option>
                        <option value="ordens">Ordens de Produção</option>
                        <option value="apontamentos">Apontamentos</option>
                        <option value="recursos">Recursos</option>
                    </select>
                </div>
            </div>

            <div class="card">
                <div class="card-header bg-info text-white">
                    <h6 class="mb-0"><i class="bi bi-list-columns"></i> Campos Disponíveis</h6>
                </div>
                <div class="card-body" id="camposDisponiveis" style="max-height: 500px; overflow-y: auto;">
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i> Selecione uma fonte de dados para ver os campos disponíveis
                    </div>
                </div>
            </div>
        </div>

        <!-- Painel Central - Área de Construção -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h6 class="mb-0"><i class="bi bi-grid-3x3-gap"></i> Campos Selecionados</h6>
                </div>
                <div class="card-body" id="camposSelecionados" 
                     style="min-height: 400px; border: 2px dashed #ddd; background-color: #f8f9fa;">
                    <div class="text-center text-muted py-5" id="emptyState">
                        <i class="bi bi-cursor" style="font-size: 4rem;"></i>
                        <p class="mt-3">Arraste os campos aqui para construir seu relatório</p>
                    </div>
                </div>
            </div>

            <!-- Configurações do Relatório -->
            <div class="card mt-3">
                <div class="card-header">
                    <h6 class="mb-0"><i class="bi bi-gear"></i> Configurações do Relatório</h6>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label">Nome do Relatório</label>
                        <input type="text" class="form-control" id="nomeRelatorio" placeholder="Ex: Relatório de Produção Mensal">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Descrição</label>
                        <textarea class="form-control" id="descricaoRelatorio" rows="2" 
                                  placeholder="Descrição opcional do relatório"></textarea>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="relatorioPublico">
                        <label class="form-check-label" for="relatorioPublico">
                            Relatório público (visível para todos os usuários)
                        </label>
                    </div>
                </div>
            </div>
        </div>

        <!-- Painel Direito - Preview e Filtros -->
        <div class="col-md-3">
            <div class="card mb-3">
                <div class="card-header bg-warning text-dark">
                    <h6 class="mb-0"><i class="bi bi-funnel"></i> Filtros</h6>
                </div>
                <div class="card-body">
                    <div id="filtrosContainer">
                        <button type="button" class="btn btn-sm btn-outline-primary w-100" onclick="adicionarFiltro()">
                            <i class="bi bi-plus"></i> Adicionar Filtro
                        </button>
                        <div id="listaFiltros" class="mt-2"></div>
                    </div>
                </div>
            </div>

            <div class="card mb-3">
                <div class="card-header bg-secondary text-white">
                    <h6 class="mb-0"><i class="bi bi-sort-down"></i> Ordenação</h6>
                </div>
                <div class="card-body">
                    <select class="form-select form-select-sm mb-2" id="campoOrdenacao">
                        <option value="">Selecione um campo...</option>
                    </select>
                    <select class="form-select form-select-sm" id="direcaoOrdenacao">
                        <option value="asc">Crescente</option>
                        <option value="desc">Decrescente</option>
                    </select>
                </div>
            </div>

            <div class="card">
                <div class="card-header bg-dark text-white">
                    <h6 class="mb-0"><i class="bi bi-collection"></i> Agrupamento</h6>
                </div>
                <div class="card-body">
                    <select class="form-select form-select-sm" id="campoAgrupamento">
                        <option value="">Sem agrupamento</option>
                    </select>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Template para Campo Selecionado -->
<template id="templateCampoSelecionado">
    <div class="campo-selecionado mb-2 p-2 bg-white border rounded" draggable="true">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <i class="bi bi-grip-vertical text-muted me-2"></i>
                <span class="campo-label"></span>
            </div>
            <button type="button" class="btn btn-sm btn-outline-danger" onclick="removerCampo(this)">
                <i class="bi bi-x"></i>
            </button>
        </div>
    </div>
</template>

<!-- Template para Filtro -->
<template id="templateFiltro">
    <div class="filtro-item mb-2 p-2 border rounded bg-light">
        <select class="form-select form-select-sm mb-1 filtro-campo">
            <option value="">Selecione o campo...</option>
        </select>
        <select class="form-select form-select-sm mb-1 filtro-operador">
            <option value="igual">Igual a</option>
            <option value="diferente">Diferente de</option>
            <option value="maior">Maior que</option>
            <option value="menor">Menor que</option>
            <option value="contem">Contém</option>
        </select>
        <input type="text" class="form-control form-control-sm mb-1 filtro-valor" placeholder="Valor">
        <button type="button" class="btn btn-sm btn-outline-danger w-100" onclick="removerFiltro(this)">
            <i class="bi bi-trash"></i> Remover
        </button>
    </div>
</template>

@section Scripts {
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script>
    let camposDisponiveis = [];
    let camposSelecionadosArray = [];

    // Definir campos por fonte de dados
    const camposPorFonte = {
        ordens: @Html.Raw(Json.Serialize(ViewBag.CamposOrdemProducao)),
        apontamentos: @Html.Raw(Json.Serialize(ViewBag.CamposApontamento)),
        recursos: @Html.Raw(Json.Serialize(ViewBag.CamposRecurso))
    };

    function carregarCampos() {
        const fonte = document.getElementById('fonteDados').value;
        const container = document.getElementById('camposDisponiveis');
        
        if (!fonte) {
            container.innerHTML = '<div class="alert alert-info"><i class="bi bi-info-circle"></i> Selecione uma fonte de dados</div>';
            return;
        }

        camposDisponiveis = camposPorFonte[fonte] || [];
        
        let html = '';
        camposDisponiveis.forEach(campo => {
            html += `
                <div class="campo-disponivel mb-2 p-2 bg-light border rounded" 
                     draggable="true" 
                     data-campo="${campo.campo}" 
                     data-label="${campo.label}"
                     data-tipo="${campo.tipo}">
                    <i class="bi bi-grip-vertical text-muted me-2"></i>
                    <i class="bi bi-database me-1"></i>
                    ${campo.label}
                    <button class="btn btn-sm btn-primary float-end" onclick="adicionarCampo('${campo.campo}', '${campo.label}', '${campo.tipo}')">
                        <i class="bi bi-plus"></i>
                    </button>
                </div>
            `;
        });
        
        container.innerHTML = html;
        
        // Adicionar evento de drag
        document.querySelectorAll('.campo-disponivel').forEach(elem => {
            elem.addEventListener('dragstart', handleDragStart);
        });
    }

    function adicionarCampo(campo, label, tipo) {
        if (camposSelecionadosArray.some(c => c.campo === campo)) {
            alert('Este campo já foi adicionado!');
            return;
        }

        camposSelecionadosArray.push({ campo, label, tipo });
        renderizarCamposSelecionados();
        atualizarSelectsOrdenacaoAgrupamento();
    }

    function removerCampo(btn) {
        const campoDiv = btn.closest('.campo-selecionado');
        const campo = campoDiv.dataset.campo;
        
        camposSelecionadosArray = camposSelecionadosArray.filter(c => c.campo !== campo);
        renderizarCamposSelecionados();
        atualizarSelectsOrdenacaoAgrupamento();
    }

    function renderizarCamposSelecionados() {
        const container = document.getElementById('camposSelecionados');
        const emptyState = document.getElementById('emptyState');
        
        if (camposSelecionadosArray.length === 0) {
            emptyState.style.display = 'block';
            container.querySelectorAll('.campo-selecionado').forEach(el => el.remove());
            return;
        }
        
        emptyState.style.display = 'none';
        container.innerHTML = '';
        
        camposSelecionadosArray.forEach(campo => {
            const template = document.getElementById('templateCampoSelecionado');
            const clone = template.content.cloneNode(true);
            
            const div = clone.querySelector('.campo-selecionado');
            div.dataset.campo = campo.campo;
            div.dataset.tipo = campo.tipo;
            div.querySelector('.campo-label').textContent = campo.label;
            
            container.appendChild(clone);
        });

        // Tornar a lista ordenável
        new Sortable(container, {
            animation: 150,
            ghostClass: 'sortable-ghost',
            handle: '.bi-grip-vertical',
            onEnd: function(evt) {
                const item = camposSelecionadosArray.splice(evt.oldIndex, 1)[0];
                camposSelecionadosArray.splice(evt.newIndex, 0, item);
            }
        });
    }

    function atualizarSelectsOrdenacaoAgrupamento() {
        const selectOrdenacao = document.getElementById('campoOrdenacao');
        const selectAgrupamento = document.getElementById('campoAgrupamento');
        
        let options = '<option value="">Selecione...</option>';
        camposSelecionadosArray.forEach(campo => {
            options += `<option value="${campo.campo}">${campo.label}</option>`;
        });
        
        selectOrdenacao.innerHTML = options;
        selectAgrupamento.innerHTML = '<option value="">Sem agrupamento</option>' + options;
    }

    function adicionarFiltro() {
        const template = document.getElementById('templateFiltro');
        const clone = template.content.cloneNode(true);
        
        const select = clone.querySelector('.filtro-campo');
        let options = '<option value="">Selecione o campo...</option>';
        camposSelecionadosArray.forEach(campo => {
            options += `<option value="${campo.campo}">${campo.label}</option>`;
        });
        select.innerHTML = options;
        
        document.getElementById('listaFiltros').appendChild(clone);
    }

    function removerFiltro(btn) {
        btn.closest('.filtro-item').remove();
    }

    function handleDragStart(e) {
        e.dataTransfer.effectAllowed = 'copy';
        e.dataTransfer.setData('text/plain', JSON.stringify({
            campo: this.dataset.campo,
            label: this.dataset.label,
            tipo: this.dataset.tipo
        }));
    }

    // Configurar drop zone
    document.getElementById('camposSelecionados').addEventListener('dragover', function(e) {
        e.preventDefault();
        e.dataTransfer.dropEffect = 'copy';
        this.style.backgroundColor = '#e7f3ff';
    });

    document.getElementById('camposSelecionados').addEventListener('dragleave', function(e) {
        this.style.backgroundColor = '#f8f9fa';
    });

    document.getElementById('camposSelecionados').addEventListener('drop', function(e) {
        e.preventDefault();
        this.style.backgroundColor = '#f8f9fa';
        
        const data = JSON.parse(e.dataTransfer.getData('text/plain'));
        adicionarCampo(data.campo, data.label, data.tipo);
    });

    async function salvarRelatorio() {
        const nome = document.getElementById('nomeRelatorio').value;
        const descricao = document.getElementById('descricaoRelatorio').value;
        const publico = document.getElementById('relatorioPublico').checked;
        const fonteDados = document.getElementById('fonteDados').value;

        if (!nome) {
            alert('Por favor, informe o nome do relatório');
            return;
        }

        if (camposSelecionadosArray.length === 0) {
            alert('Selecione pelo menos um campo para o relatório');
            return;
        }

        if (!fonteDados) {
            alert('Selecione a fonte de dados');
            return;
        }

        // Coletar filtros
        const filtros = [];
        document.querySelectorAll('.filtro-item').forEach(item => {
            const campo = item.querySelector('.filtro-campo').value;
            const operador = item.querySelector('.filtro-operador').value;
            const valor = item.querySelector('.filtro-valor').value;
            
            if (campo && valor) {
                filtros.push({ campo, operador, valor });
            }
        });

        const dados = {
            nome: nome,
            descricao: descricao,
            tipoRelatorio: fonteDados === 'ordens' ? 'Ordens de Produção' : 
                          fonteDados === 'apontamentos' ? 'Apontamentos' : 'Recursos',
            configuracao: {
                fonteDados: fonteDados,
                campos: camposSelecionadosArray
            },
            camposSelecionados: camposSelecionadosArray.map(c => c.campo),
            filtros: filtros.length > 0 ? filtros : null,
            ordenacao: document.getElementById('campoOrdenacao').value + '|' + document.getElementById('direcaoOrdenacao').value,
            agrupamento: document.getElementById('campoAgrupamento').value,
            publico: publico
        };

        try {
            const response = await fetch('/RelatorioPCP/SaveBuilder', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(dados)
            });

            const result = await response.json();
            
            if (result.success) {
                alert(result.message);
                window.location.href = '/RelatorioPCP/Index';
            } else {
                alert('Erro: ' + result.message);
            }
        } catch (error) {
            console.error('Erro:', error);
            alert('Erro ao salvar o relatório');
        }
    }
</script>

<style>
    .campo-disponivel, .campo-selecionado {
        cursor: move;
        transition: all 0.2s;
    }
    
    .campo-disponivel:hover, .campo-selecionado:hover {
        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        transform: translateY(-2px);
    }
    
    .sortable-ghost {
        opacity: 0.4;
        background: #c8ebfb;
    }
    
    #camposSelecionados {
        transition: background-color 0.2s;
    }
</style>
}
